{{ if eq .chezmoi.os "linux" -}}


{{/* ==== Arch Linux / Manjaro ========================================== */ -}}
{{ if or (eq .chezmoi.osRelease.id "manjaro") (eq .chezmoi.osRelease.id "arch") -}}

{{/* ---- æ•´ç†å¾…å®‰è£æ¸…å–® -------------------------------------------------- */ -}}

{{- $pacman_force := .packages.linux.arch.pacman_force -}}
{{- $pacmanInstall := .packages.linux.arch.pacman -}}
{{- $aurInstall := .packages.linux.arch.aur -}}
{{- if not .noGUI -}}
{{- $pacmanInstall := concat .packages.linux.arch.pacman .packages.linux.arch.pacman_gui -}}
{{- $aurInstall := concat .packages.linux.arch.aur .packages.linux.arch.aur_gui -}}
{{- end -}}

{{ if eq .chezmoi.osRelease.id "manjaro" -}}
{{- $pacman_force := .packages.linux.manjaro.pacman_force -}}
{{- $pacmanInstall := .packages.linux.manjaro.pacman -}}
{{- $aurInstall := .packages.linux.manjaro.aur -}}
{{- if not .noGUI -}}
{{- $pacmanInstall := concat .packages.linux.manjaro.pacman .packages.linux.manjaro.pacman_gui -}}
{{- $aurInstall := concat .packages.linux.manjaro.aur .packages.linux.manjaro.aur_gui -}}
{{- end -}}
{{ end -}}

{{/* ---- å®‰è£è…³æœ¬ ------------------------------------------------------- */ -}}
{{- /* https://github.com/mriehl/dotfiles/blob/master/run_onchange_packages.sh.tmpl */ -}}
#!/usr/bin/env bash

wait_for_pacman_unlock() {
  local LOCKFILE="/var/lib/pacman/db.lck"
  local MAX_IDLE=10    # å¦‚æžœæ²’æœ‰ pacman processï¼Œæœ€å¤šç­‰é€™éº¼ä¹…å†è‡ªå‹•ç§»é™¤æ®˜ç•™
  local WAITED=0

  echo "â³ æª¢æŸ¥ pacman éŽ–å®šä¸­..."

  while [ -e "$LOCKFILE" ]; do
    if ! pgrep -x pacman >/dev/null && \
       ! pgrep -x packagekitd >/dev/null && \
       ! pgrep -x packagekit >/dev/null; then

       echo "ðŸ” æ‰¾ä¸åˆ° pacman æˆ– PackageKitï¼Œç–‘ä¼¼æ®˜ç•™éŽ–æª”ã€‚"

       if [ "$WAITED" -ge "$MAX_IDLE" ]; then
         echo "ðŸ§¹ è‡ªå‹•ç§»é™¤æ®˜ç•™éŽ–æª”ï¼ˆå·²é–’ç½® $MAX_IDLE ç§’ï¼‰"
         sudo rm -f "$LOCKFILE"
         break
       fi

       WAITED=$((WAITED + 1))
    fi

    sleep 1
  done

  echo "âœ… éŽ–å®šè§£é™¤ï¼Œç¹¼çºŒåŸ·è¡Œã€‚"
}

pacmanForce_packages=( {{ $pacman_force | quoteList | join " " }})
pacman_packages=( {{ $pacmanInstall | quoteList | join " " }} )
aur_packages=( {{ $aurInstall | quoteList | join " " }})

installed_packages=($(pacman -Qq))

is_installed() {
  [[ " ${installed_packages[*]} " =~ " $1 " ]]
}

to_install_pacmanForce=()
for package in "${pacmanForce_packages[@]}"; do
  to_install_pacmanForce+=("$package")
done

# ç­‰å¾…éŽ–å®šæª”æ¡ˆè¢«ç§»é™¤
wait_for_pacman_unlock

if [[ ${#to_install_pacmanForce[@]} -gt 0 ]]; then
  echo "  - Installing missing packages via pacman: ${to_install_pacmanForce[@]}"
  sudo pacman -Sy --needed --noconfirm "${to_install_pacmanForce[@]}"
else
  sudo pacman -Sy
fi

# ç­‰å¾…éŽ–å®šæª”æ¡ˆè¢«ç§»é™¤
wait_for_pacman_unlock

to_install_pacman=()
for package in "${pacman_packages[@]}"; do
  if ! is_installed "$package"; then
    to_install_pacman+=("$package")
  fi
done

if [[ ${#to_install_pacman[@]} -gt 0 ]]; then
  echo "  - Installing missing packages via pacman: ${to_install_pacman[@]}"
  sudo pacman -S --needed --noconfirm "${to_install_pacman[@]}"
fi

# ç­‰å¾…éŽ–å®šæª”æ¡ˆè¢«ç§»é™¤
wait_for_pacman_unlock

{{ if eq .chezmoi.osRelease.id "manjaro" -}}
if ! is_installed "yay"; then
  echo "  - Installing yay"
  sudo pacman -S --needed --noconfirm yay
fi
{{ else -}}
if ! command -v yay &> /dev/null; then
    git clone https://aur.archlinux.org/yay-bin.git && cd yay-bin && makepkg -si
fi
{{ end -}}

to_install_aur=()
for package in "${aur_packages[@]}"; do
  if ! is_installed "$package"; then
    to_install_aur+=("$package")
  fi
done

if [[ ${#to_install_aur[@]} -gt 0 ]]; then
  echo "  - Installing missing AUR packages via yay: ${to_install_aur[@]}"
  yay -S --noconfirm "${to_install_aur[@]}"
fi
{{ end -}}

{{ end -}}
